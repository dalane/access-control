'use strict';
var AbstractSpecification = (function () {
    /**
     * Instantiate a specification with the path that will be checked when
     * isSatisfiedBy is called. The expected value is what the actual value found
     * in the path will be compared against.
     * @param  {String} path            The path in the accessRequest that will be checked when isSatisfied is called
     * @param  {Variant} expected       The value that is expected to be at the location identified in the path. Can also be another attribute in the access request by entering '${path.to.attribute}'
     */
    function AbstractSpecification(attribute, expected, options) {
        if (options === void 0) { options = {}; }
        this._attributePath = attribute;
        this._attributePathSegments = attribute.split('.');
        // some specifications don't require an expected value, i.e. isTrue, isNull, etc
        // so only check expected if it's not null...
        if (expected !== null) {
            // this regular expression will match
            var checkExpectedRegExp = /\$\{([^}]+)\}/;
            var result = checkExpectedRegExp.exec(expected);
            if (result !== null) {
                this._expectedIsAttribute = true;
                this._expectedAttribute = result[1];
                this._expectedValue = null;
                this._expectedAttributePathSegments = this._expectedAttribute.split('.');
            }
            else {
                this._expectedIsAttribute = false;
                this._expectedAttribute = null;
                this._expectedValue = expected;
            }
            this._expected = expected;
        }
        this._options = options;
    }
    Object.defineProperty(AbstractSpecification.prototype, "options", {
        /**
         * Returns an object containing the options that were set in the constructor.
         * @return {Object} [description]
         */
        get: function () {
            return this._options;
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(AbstractSpecification.prototype, "attribute", {
        /**
         * Returns the attribute that is to be checked in the access request.
         * @return {String} The path in the accessRequest that will be checked when isSatisfied is called
         */
        get: function () {
            return this._attributePath;
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(AbstractSpecification.prototype, "expected", {
        /**
         * Returns the value that is to be compared to the access request as set in the constructor.
         * @return {*} The value that is expected to be at the location identified in the path. May also be another attribute in the access request with the format '${path.to.attribute}'
         */
        get: function () {
            return this._expected;
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(AbstractSpecification.prototype, "expectedIsAttribute", {
        /**
         * Identifies if the expected value is another attribute. This is set using the format ${path.to.attribute}.
         * @return {Boolean} True if the expected value is another attribute
         */
        get: function () {
            return this._expectedIsAttribute;
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(AbstractSpecification.prototype, "expectedAttribute", {
        /**
         * If the expected value is another attribute (i.e. '${path.to.attribute}') this will return 'path.to.attribute'.
         * @return {String} The extracted expected attribute path
         */
        get: function () {
            return this._expectedAttribute;
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(AbstractSpecification.prototype, "expectedValue", {
        /**
         * If the expected value was not set to be an attribute lookup this is the value that was set in the constructor.
         * @return {*} The value to be compared to the access request
         */
        get: function () {
            return this._expectedValue;
        },
        enumerable: true,
        configurable: true
    });
    /**
     * Checks if the value found at attribute in the access request satisfies the specification rules when compared to the expected value.
     * @param  {AccessRequest}  accessRequest The access request as generated by the PEP
     * @return {Boolean}               True if the value in the access request meets the specification rules
     */
    AbstractSpecification.prototype.isSatisfiedBy = function (accessRequest) {
        throw new Error('Abstract base class is to be extended');
    };
    /**
     * An internal function used by the specification to extract the value found at the attribute path in the access request.
     * @param  {AccessRequest} accessRequest The access request as generated by the PEP
     * @return {*}               The value found at the attribute path in the access request
     */
    AbstractSpecification.prototype._getActualValue = function (accessRequest) {
        return this._getValueFromAccessRequest(accessRequest, this._attributePathSegments);
    };
    /**
     * An internal function used by the specification to extract the expected value. It will return the expected value unless it's another attribute then it will extract the expected value from the acces request.
     * @param  {AccessRequest} accessRequest The access request as generated by the PEP
     * @return {*}               The expected value as set in the constructor or a value extracted from the access request
     */
    AbstractSpecification.prototype._getExpectedValue = function (accessRequest) {
        return (this._expectedIsAttribute) ? this._getValueFromAccessRequest(accessRequest, this._expectedAttributePathSegments) : this._expectedValue;
    };
    /**
     * An internal function to extract a value from the access request located at the specified 'path.to.attribute'
     * @param  {AccessRequest} accessRequest The access request created by the PEP
     * @param  {[String]} segments      The path to the attribute already split into segments
     * @return {*}
     */
    AbstractSpecification.prototype._getValueFromAccessRequest = function (accessRequest, segments) {
        var current = accessRequest;
        for (var i = 0; i < segments.length; i++) {
            var segment = segments[i];
            if (!current.has(segment)) {
                return undefined;
            }
            else {
                current = current.get(segment);
            }
        }
        return current;
    };
    return AbstractSpecification;
}());
module.exports = AbstractSpecification;
